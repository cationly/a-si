variable filename string 131114a
variable restartfile string 131114a.quenched.restart

read_restart ${restartfile}

variable T equal 300
#variable dT equal $T/3
variable dT equal 200
variable TL equal $T+${dT}/2
variable TR equal $T-${dT}/2

log ${filename}.log

variable Tdamp equal 1.0 # In picoseconds

atom_modify sort 0 0.0
pair_style sw
pair_coeff * * mylammps/potentials/Si_vbwm.sw Si
timestep 0.0005 # Used in ?

variable Lfixed equal 8.0
variable Lbath equal 20.0
variable Lhelp equal zhi-${Lfixed}
variable Lhelp2 equal zhi-${Lbath}

variable dmid equal 3
variable xmid equal (xhi+xlo)/2.0
variable xmidlo equal ${xmid}-${dmid}
variable xmidhi equal ${xmid}+${dmid}

variable steps_equil equal 200
variable steps_steady equal 300
variable steps_simu equal 500

region 1 block EDGE EDGE EDGE EDGE EDGE ${Lfixed}
region 2 block EDGE EDGE EDGE EDGE ${Lhelp} EDGE
region 3 block EDGE EDGE EDGE EDGE EDGE ${Lbath}
region 4 block EDGE EDGE EDGE EDGE ${Lhelp2} EDGE

region left block ${xmidlo} ${xmid} INF INF INF INF
region right block ${xmid} ${xmidhi} INF INF INF INF

group fixedL region 1
group fixedR region 2
group fixed union fixedL fixedR

group hot region 3
group hot subtract hot fixedL
group cold region 4
group cold subtract cold fixedR

group interface_left region left
group interface_right region right
group interface union interface_left interface_right

group mobile subtract all fixed

thermo_style custom step temp etotal cpu cpuremain

velocity all create ${T} 23423424 dist gaussian mom yes

variable Tis atom ${TL}+x/xhi*(${TR}-${TL})

# FIXES
thermo 100
fix NVE mobile nve
fix NVT mobile langevin v_Tis 1.0 ${Tdamp} 9348734 # zero yes

run ${steps_equil}

# dump start_coords all xyz 50 ${filename}_traj_start.xyz
# run 2000
# undump start_coords

write_restart ${filename}.equil.restart
# quit
# Write the restart data to file

unfix NVT

# dump equil_coords all xyz 10 ${filename}_traj.xyz
# Check the energy conservation
thermo 10
# run 1000
# undump equil_coords
thermo 100
# Hot bath
fix HOT hot langevin ${TL} ${TL} ${Tdamp} 12223 tally yes # gjf yes
# Cold bath
fix COLD cold langevin ${TR} ${TR} ${Tdamp} 2276822 tally yes # gjf yes

dump simu_coords all xyz 20000 ${filename}_simu.xyz

compute KE all ke/atom

variable convert equal 2.0/3.0*1.602e-19/1.38e-23

variable Ti atom c_KE*${convert}
variable Ti2 atom v_Ti*v_Ti

fix ave_KE_start all ave/spatial 100 500 50000 x lower 5 v_Ti v_Ti2 units box ave one file ${filename}.Ti_start.dat title1 "Atomic temperatures"

# Wait for steady state
run ${steps_steady}
unfix ave_KE_start
# quit

write_restart ${filename}.steadystate.restart
# quit
fix aveinput hot ave/time 1 1 100 f_HOT ave one file ${filename}.aveinput_hot.dat
fix aveinput_cold cold ave/time 1 1 100 f_COLD ave one file ${filename}.aveinput_cold.dat

fix ave_KE all ave/spatial 100 1 100 x lower 5 v_Ti v_Ti2 units box ave running file &
${filename}.Ti.dat overwrite title1 "Kinetic energies"

# undump equil_coords

# ALL COMPUTES

thermo 10000
variable dt_dump equal 10
# dump pairs interface local ${dt_dump} forces.dat index c_atomids[1] c_atomids[2] c_atomids[3] c_atomids[4] c_forces[1] c_forces[2] c_forces[3]
dump vels interface custom ${dt_dump} ${filename}.vels.dat id type vx vy vz
dump_modify vels format "%d %d %.8g %.8g %.8g"
dump_modify vels sort id

dump pos interface custom 1000 ${filename}.pos.dat id type x y z
dump_modify pos format "%d %d %.8g %.8g %.8g"
dump_modify pos sort id

#dump velsL interfaceL custom ${dt_dump} ${filename}.velsL.dat id type vx vy vz
#dump_modify velsL format "%d %d %.8g %.8g %.8g"
#dump_modify velsL sort id

#dump velsR interfaceR custom ${dt_dump} ${filename}.velsR.dat id type vx vy vz
#dump_modify velsR format "%d %d %.8g %.8g %.8g"
#dump_modify velsR sort id
# thermo_style custom step v_ke
# fix printtaus all print 10 "ke=${ke}"

#dump_modify vels buffer no
#dump_modify velsL buffer no
#dump_modify velsR buffer no
restart 10000000 ${filename}.*.restart

run ${steps_simu}

undump vels
undump pos

write_restart ${filename}.end.restart


#dump final_coords all xyz 50 ${filename}_traj_final.xyz
#run 10000

quit

undump vels
#undump velsL
#undump velsR
